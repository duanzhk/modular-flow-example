{"version":3,"sources":["file:///Users/dzk/Documents/git-projects/example-mflow/node_modules/dzkcc-mflow/dist/libs/UIManager.js"],"names":["CcocosUIManager","UIManager","addWidget","node","widget","getComponent","Widget","addComponent","isAlignLeft","isAlignRight","isAlignTop","isAlignBottom","left","right","top","bottom","setLayer","layer","UIRoot","children","forEach","child","addChild","director","Node","Sprite","Input","input","instantiate","__awaiter","ServiceLocator","Proxy","get","target","prop","_uiRoot","canvas","getScene","getChildByPath","addPersistRootNode","setParent","Reflect","UIMask","_uiMask","setPosition","color","set","value","bind","p","newValue","receiver","active","getTopView","internalGetTopView","open","viewType","args","vt","internalOpen","close","viewortype","destory","internalClose","openAndPush","group","internalOpenAndPush","closeAndPop","destroy","internalCloseAndPop","clearStack","internalClearStack","constructor","_cache","Map","_groupStacks","on","EventType","TOUCH_END","event","view","__group__","undefined","_getPrefabPath","prototype","Object","getPrototypeOf","hasOwnProperty","__path__","Error","name","_adjustMaskLayer","length","setSiblingIndex","Math","max","_blockInput","block","blocker","propagationImmediateStopped","eventType","off","_load","has","prefabPath","ResMgr","getService","prefab","loadPrefab","_remove","_a","cached","console","warn","onExit","removeFromParent","cacheKey","delete","reverse","comps","components","i","comp","__isIView__","onEnter","stack","onPause","push","pop","onResume"],"mappings":"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","sourcesContent":["import { __awaiter } from '../_virtual/_tslib.js';\nimport { director, Node, Sprite, Widget, Input, input, instantiate } from 'cc';\nimport { ServiceLocator } from '../core/ServiceLocator.js';\nimport 'reflect-metadata';\n\nfunction addWidget(node) {\r\n    const widget = node.getComponent(Widget) || node.addComponent(Widget);\r\n    widget.isAlignLeft = widget.isAlignRight = widget.isAlignTop = widget.isAlignBottom = true;\r\n    widget.left = widget.right = widget.top = widget.bottom = 0;\r\n}\r\nlet _uiRoot;\r\nconst UIRoot = new Proxy({}, {\r\n    get(target, prop) {\r\n        if (!_uiRoot) {\r\n            const canvas = director.getScene().getChildByPath('Canvas');\r\n            director.addPersistRootNode(canvas);\r\n            _uiRoot = new Node('__UIRoot__');\r\n            _uiRoot.layer = canvas.layer;\r\n            _uiRoot.setParent(canvas);\r\n            addWidget(_uiRoot);\r\n        }\r\n        return Reflect.get(_uiRoot, prop);\r\n    }\r\n});\r\nfunction setLayer(node) {\r\n    node.layer = UIRoot.layer;\r\n    node.children.forEach(child => {\r\n        setLayer(child);\r\n    });\r\n}\r\nfunction addChild(node) {\r\n    UIRoot.addChild(node);\r\n    setLayer(node);\r\n}\r\nlet _uiMask;\r\nconst UIMask = new Proxy({}, {\r\n    get(target, prop) {\r\n        if (!_uiMask) {\r\n            _uiMask = new Node('__UIMask__');\r\n            addChild(_uiMask);\r\n            addWidget(_uiMask);\r\n            _uiMask.setPosition(0, 0);\r\n            _uiMask.addComponent(Sprite).color.set(0, 0, 0, 0.5);\r\n        }\r\n        const value = Reflect.get(_uiMask, prop);\r\n        // 如果是放的话，可能要绑定原始实例上下文\r\n        return typeof value === 'function' ? value.bind(_uiMask) : value;\r\n        // return Reflect.get(_uiMask, prop)\r\n    },\r\n    set(target, p, newValue, receiver) {\r\n        if (p === 'active') {\r\n            _uiMask.active = newValue;\r\n            return true;\r\n        }\r\n        return Reflect.set(_uiMask, p, newValue, receiver);\r\n    }\r\n});\r\n// 接口隔离，实现具体的CcocosUIManager\r\nclass CcocosUIManager {\r\n    getTopView() {\r\n        return this.internalGetTopView();\r\n    }\r\n    open(viewType, args) {\r\n        let vt = viewType;\r\n        return this.internalOpen(vt, args);\r\n    }\r\n    close(viewortype, destory) {\r\n        this.internalClose(viewortype, destory);\r\n    }\r\n    openAndPush(viewType, group, args) {\r\n        let vt = viewType;\r\n        return this.internalOpenAndPush(vt, group, args);\r\n    }\r\n    closeAndPop(group, destroy) {\r\n        this.internalCloseAndPop(group, destroy);\r\n    }\r\n    clearStack(group, destroy) {\r\n        this.internalClearStack(group, destroy);\r\n    }\r\n}\r\nclass UIManager extends CcocosUIManager {\r\n    constructor() {\r\n        super();\r\n        this._cache = new Map();\r\n        this._groupStacks = new Map();\r\n        UIMask.on(Node.EventType.TOUCH_END, (event) => {\r\n            let view = this.getTopView();\r\n            if ('__group__' in view) {\r\n                if (view.__group__ != undefined) {\r\n                    this.closeAndPop(view.__group__, false);\r\n                }\r\n                else {\r\n                    this.close(view, false);\r\n                }\r\n            }\r\n        });\r\n    }\r\n    _getPrefabPath(viewType) {\r\n        let prototype = Object.getPrototypeOf(viewType);\r\n        // 沿着原型链向上查找直到找到定义__path__的基类。注意通过类只能找到静态属性。\r\n        while (prototype) {\r\n            if (prototype.hasOwnProperty('__path__')) {\r\n                return prototype.__path__;\r\n            }\r\n            prototype = Object.getPrototypeOf(prototype);\r\n        }\r\n        throw new Error(`Prefab path not found for ${viewType.constructor.name}`);\r\n    }\r\n    // 调整Mask层级\r\n    _adjustMaskLayer() {\r\n        let children = UIRoot.children;\r\n        if (children.length == 1) {\r\n            UIMask.active = false;\r\n            return;\r\n        }\r\n        UIMask.active = true;\r\n        UIMask.setSiblingIndex(Math.max(children.length - 2, 0));\r\n    }\r\n    _blockInput(block) {\r\n        function blocker(event) {\r\n            event.propagationImmediateStopped = true;\r\n        }\r\n        if (block) {\r\n            for (const eventType in Input.EventType) {\r\n                input.on(Input.EventType[eventType], blocker);\r\n            }\r\n        }\r\n        else {\r\n            for (const eventType in Input.EventType) {\r\n                input.off(Input.EventType[eventType], blocker);\r\n            }\r\n        }\r\n    }\r\n    _load(viewType, args) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            let target;\r\n            if (this._cache.has(viewType.name)) {\r\n                target = this._cache.get(viewType.name);\r\n            }\r\n            else {\r\n                let prefabPath = this._getPrefabPath(viewType);\r\n                const ResMgr = ServiceLocator.getService('ResLoader');\r\n                const prefab = yield ResMgr.loadPrefab(prefabPath);\r\n                target = instantiate(prefab);\r\n                this._cache.set(viewType.name, target);\r\n            }\r\n            return target.getComponent(viewType);\r\n        });\r\n    }\r\n    _remove(viewortype, destroy) {\r\n        var _a;\r\n        if (typeof viewortype == 'function') {\r\n            const cached = this._cache.get(viewortype.name);\r\n            if (!cached) {\r\n                console.warn(`No cached view found for ${viewortype.name}`);\r\n                return;\r\n            }\r\n            this._remove(cached.getComponent(viewortype), destroy);\r\n            return;\r\n        }\r\n        if ('__group__' in viewortype) {\r\n            viewortype.__group__ = undefined;\r\n        }\r\n        viewortype.onExit();\r\n        viewortype.node.removeFromParent();\r\n        if (destroy) {\r\n            let cacheKey = viewortype.constructor.name;\r\n            (_a = this._cache.get(cacheKey)) === null || _a === void 0 ? void 0 : _a.destroy();\r\n            this._cache.delete(cacheKey);\r\n        }\r\n    }\r\n    internalGetTopView() {\r\n        let target = UIRoot.children.reverse()[0];\r\n        if (!target) {\r\n            return undefined;\r\n        }\r\n        const comps = target.components;\r\n        for (let i = 0; i < comps.length; i++) {\r\n            const comp = comps[i];\r\n            if (\"__isIView__\" in comp) {\r\n                if (comp.__isIView__) {\r\n                    return comp;\r\n                }\r\n            }\r\n        }\r\n        console.warn(`No view found in ${target.name}`);\r\n        return undefined;\r\n    }\r\n    internalOpen(viewType, args) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            this._blockInput(true);\r\n            let view = yield this._load(viewType, args);\r\n            addChild(view.node);\r\n            this._adjustMaskLayer();\r\n            view.onEnter(args);\r\n            this._blockInput(false);\r\n            return view;\r\n        });\r\n    }\r\n    internalClose(viewortype, destroy) {\r\n        this._remove(viewortype, destroy);\r\n        this._adjustMaskLayer();\r\n    }\r\n    internalOpenAndPush(viewType, group, args) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            this._blockInput(true);\r\n            let view = yield this._load(viewType, args);\r\n            let stack = this._groupStacks.get(group) || [];\r\n            this._groupStacks.set(group, stack);\r\n            let top = stack[stack.length - 1];\r\n            if (top) {\r\n                top.onPause();\r\n                top.node.removeFromParent();\r\n            }\r\n            if ('__group__' in view) {\r\n                view.__group__ = group;\r\n            }\r\n            stack.push(view);\r\n            addChild(view.node);\r\n            this._adjustMaskLayer();\r\n            view.onEnter(args);\r\n            this._blockInput(false);\r\n            return view;\r\n        });\r\n    }\r\n    internalCloseAndPop(group, destroy) {\r\n        let stack = this._groupStacks.get(group);\r\n        if (!stack) {\r\n            console.warn(`No stack found for group ${group}`);\r\n            return;\r\n        }\r\n        if (stack.length == 0) {\r\n            console.warn(`Stack is empty for group ${group}`);\r\n            return;\r\n        }\r\n        this._remove(stack.pop(), destroy);\r\n        let top = stack[stack.length - 1];\r\n        if (top) {\r\n            top.onResume();\r\n            addChild(top.node);\r\n        }\r\n        this._adjustMaskLayer();\r\n    }\r\n    internalClearStack(group, destroy) {\r\n        let stack = this._groupStacks.get(group);\r\n        if (!stack) {\r\n            console.warn(`No stack found for group ${group}`);\r\n            return;\r\n        }\r\n        while (stack.length > 0) {\r\n            let view = stack.pop();\r\n            if (view) {\r\n                this._remove(view, destroy);\r\n            }\r\n        }\r\n    }\r\n}\n\nexport { UIManager };\n"]}